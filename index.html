/**
 * Google Apps Script web app endpoint for collecting jsPsych results.
 * Expects POST body to be JSON (sent as text/plain).
 */

const SHEET_NAME = "data"; // <-- must match your tab name
const REQUIRE_SECRET = true; // set false if you don't want a secret check
const SECRET_TOKEN = "TESTER"; // must match KC_REMOTE_SECRET in index.html

function doPost(e) {
  try {
    // Parse incoming JSON (works with Content-Type: text/plain)
    const raw = e && e.postData && e.postData.contents ? e.postData.contents : "";
    const payload = raw ? JSON.parse(raw) : {};

    // Optional simple auth
    if (REQUIRE_SECRET) {
      if (!payload.secret || payload.secret !== SECRET_TOKEN) {
        return jsonResponse({ status: "error", message: "Invalid secret" }, 401);
      }
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sh = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);

    // If the sheet is empty, add headers automatically
    if (sh.getLastRow() === 0) {
      sh.appendRow(["timestamp", "participantId", "nature_choice", "nature_importance", "total", "scores_json"]);
    }

    // Pull fields from your payload (matches the index.html payload youâ€™re sending)
    const timestamp = new Date().toISOString();
    const participantId = payload.participantId || "";
    const natureChoice = payload.nature_choice || "";
    const natureImportance = payload.nature_importance || "";
    const total = (payload.total !== undefined && payload.total !== null) ? payload.total : "";
    const scoresJson = payload.scores ? JSON.stringify(payload.scores) : "";

    sh.appendRow([timestamp, participantId, natureChoice, natureImportance, total, scoresJson]);

    return jsonResponse({ status: "ok" }, 200);

  } catch (err) {
    return jsonResponse({ status: "error", message: String(err) }, 500);
  }
}

// Helpful for testing in the browser (GET requests)
function doGet() {
  return jsonResponse({ status: "ok", message: "Collector is running" }, 200);
}

// Standard JSON response helper (also adds permissive CORS headers)
function jsonResponse(obj, code) {
  const output = ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);

  // CORS (usually not needed with text/plain POST, but harmless/helpful)
  return output;
}
