<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Habitats Survey</title>
    <meta charset="utf-8" />

    <!-- jsPsych 6.1.0 core + plugins -->
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css">

    <style>
      :root{
        /* board diameter: always fits in viewport */
        --size: min(92vmin, 920px);

        /* white rim outside the red ring (space where your tiles sit) */
        --white-margin: clamp(120px, 18vmin, 240px);

        /* ring thickness */
        --band: clamp(60px, 8vmin, 110px);

        --red-diameter: calc(var(--size) - var(--white-margin));
        --orange-band: var(--band);
        --green-band: var(--band);
      }

      html, body { background:#fff; color:#000; margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
      #jspsych-target { display:grid; place-items:center; min-height:100vh; }

      .wrap { display:flex; gap:24px; align-items:flex-start; padding:16px; }
      .board {
        position:relative;
        width:var(--size);
        height:var(--size);
        background:#fff;
        border-radius:50%;
        display:grid;
        place-items:center;
        overflow:visible;
      }
      .ring { position:absolute; border-radius:50%; left:50%; top:50%; transform:translate(-50%,-50%); pointer-events:none; }
      .ring.red    { background:#c21f1f; width:var(--red-diameter); height:var(--red-diameter); z-index:1; }
      .ring.orange { background:#ff7a21; width:calc(var(--red-diameter) - (2 * var(--orange-band))); height:calc(var(--red-diameter) - (2 * var(--orange-band))); z-index:1; }
      .ring.green  { background:#1aaa1a; width:calc(var(--red-diameter) - (2 * var(--orange-band)) - (2 * var(--green-band))); height:calc(var(--red-diameter) - (2 * var(--orange-band)) - (2 * var(--green-band))); z-index:1; }

      .ring.active { filter: brightness(1.25); box-shadow: 0 0 18px rgba(0,0,0,0.25) inset; }

      .kc-ring-help {
        position:absolute; width:44px; height:44px; border-radius:50%;
        background:rgba(255,255,255,0.95);
        border:2px solid rgba(0,0,0,0.08);
        display:flex; align-items:center; justify-content:center;
        font-weight:700; font-size:20px; cursor:pointer;
        z-index:100000;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      }
      .kc-ring-help.kc-help-red    { color:#c21f1f; }
      .kc-ring-help.kc-help-orange { color:#ff7a21; }
      .kc-ring-help.kc-help-green  { color:#1aaa1a; }

      .start-strip { width:220px; }
      .tiles { display:flex; flex-wrap:wrap; gap:8px; max-height:calc(var(--size) - 20px); overflow:auto; }
      .tile {
        width:100px; height:100px; border-radius:14px; background:transparent;
        display:flex; align-items:center; justify-content:center;
        cursor:grab; touch-action:none;
        position: relative; z-index:300001;
        font-size: 26px; font-weight:700;
      }
      .tile img { width:100%; height:100%; object-fit:contain; border-radius:12px; pointer-events:none; border:0; outline:0; }

      .item {
        position:absolute; width:130px; height:130px; border-radius:14px; background:transparent;
        display:flex; align-items:center; justify-content:center;
        cursor:grab; user-select:none; z-index:300000;
      }
      .item.dragging { opacity:.85; cursor:grabbing; }
      .item img { width:100%; height:100%; object-fit:contain; border-radius:12px; border:0; outline:0; }

      .tile-placeholder { width:130px; height:130px; display:inline-block; vertical-align:top; border-radius:14px; background:transparent; }

      .jspsych-btn { background:#28a745; color:#fff; border-radius:8px; border: none; padding: 12px 18px; font-size:18px; min-width:140px; cursor:pointer; }
      .jspsych-content { color:#000; }
      .kc-continue-btn { background: #28a745 !important; color: #fff !important; border: none; }

      .sr-only { position: absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
      .kc-flag-svg { width:40px; height:40px; display:inline-block; vertical-align:middle; }

      .jspsych-btn.flag-btn {
        background: transparent !important;
        border: none !important;
        padding: 6px !important;
        min-width: 0 !important;
        box-shadow: none !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 6px !important;
      }
      .jspsych-btn.flag-btn:focus {
        outline: none !important;
        box-shadow: 0 0 0 4px rgba(40,167,69,0.18) !important;
        border-radius: 6px !important;
      }
      .jspsych-btn.flag-btn:hover { transform: translateY(-1px); }

      /* ===== Survey page styles ===== */
      .kc-qwrap { max-width: 820px; margin: 0 auto; }
      .kc-qprompt { font-size: 1.5rem; font-weight: 800; margin: 0 0 14px 0; }
      .kc-qsub { font-size: 1rem; opacity: 0.9; margin: 0 0 14px 0; }

      .kc-textbox {
        width: 100%;
        max-width: 520px;
        font-size: 1.2rem;
        padding: 12px 14px;
        border-radius: 10px;
        border: 2px solid rgba(0,0,0,0.18);
        outline: none;
      }
      .kc-textbox:focus { border-color: rgba(40,167,69,0.9); box-shadow: 0 0 0 4px rgba(40,167,69,0.14); }

      .kc-optgrid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
      .kc-optgrid-3 .kc-opt img { height: 150px; }

      .kc-optgrid-5 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 14px; }

      .kc-opt {
        border: 2px solid rgba(0,0,0,0.12);
        border-radius: 14px;
        padding: 12px;
        cursor: pointer;
        user-select: none;
        background: #fff;
        transition: transform 120ms ease, border-color 120ms ease, box-shadow 120ms ease;
      }
      .kc-opt:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
      .kc-opt.selected {
        border-color: rgba(40,167,69,0.9);
        box-shadow: 0 0 0 4px rgba(40,167,69,0.16);
      }
      .kc-opt img { width: 100%; height: 140px; object-fit: contain; display:block; }
      .kc-optlabel { margin-top: 10px; font-size: 1.05rem; font-weight: 700; text-align: center; }

      /* ===== LABEL POPUP + CLICK HIGHLIGHT ===== */
      .tile, .item { position: relative; }

      .tile:hover .kc-label,
      .item:hover .kc-label { opacity: 1; transform: translate(-50%, 0); }

      .tile.selected .kc-label,
      .item.selected .kc-label { opacity: 1; transform: translate(-50%, 0); }

      .tile.selected, .item.selected {
        outline: 5px solid rgba(40,167,69,0.85);
        box-shadow: 0 0 0 6px rgba(40,167,69,0.18);
      }

      .kc-label {
        position: absolute;
        left: 50%;
        top: -10px;
        transform: translate(-50%, -6px);
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 6px 10px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 800;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transition: opacity 120ms ease, transform 120ms ease;
        z-index: 999999;
      }

      /* iPad / narrow screens */
      @media (max-width: 900px){
        .wrap{ flex-direction: column; align-items: center; }
        .start-strip{ width: min(92vmin, 520px); }
        .tiles{ max-height: 240px; }
      }
    </style>
  </head>

  <body>
    <script>
      window.KC_REMOTE_ENDPOINT = window.KC_REMOTE_ENDPOINT || 'https://script.google.com/macros/s/AKfycbzr8dWDuoUhPtx8kzX9Xdwllk3CB0nnLK0Tjug7mG8bbnt9F8rGLaFb45-2D2dLrsrv/exec';
      window.KC_REMOTE_SECRET = window.KC_REMOTE_SECRET || 'TESTER';
    </script>

    <div id="jspsych-target"></div>

    <script>
      // ======= GLOBALS / CONFIG =======
      var timeline = [];
      var participantId = null;

      // ======= RESUME AFTER REFRESH (15 min) =======
      var KC_RESUME_KEY = 'KC_HABITATS_STATE_v1';
      var KC_RESUME_TTL_MS = 15 * 60 * 1000;

      function kcSaveState() {
        try {
          var prog = jsPsych.progress();
          var state = {
            t: Date.now(),
            next_trial: (prog.current_trial_global || 0) + 1,
            participantId: participantId || null,
            scores: Object.assign({}, SCORES || {}),
            props: (jsPsych.data.get().values()[0] || {})
          };
          localStorage.setItem(KC_RESUME_KEY, JSON.stringify(state));
        } catch (e) {}
      }

      function kcLoadState() {
        try {
          var raw = localStorage.getItem(KC_RESUME_KEY);
          if (!raw) return null;
          var state = JSON.parse(raw);
          if (!state || !state.t) return null;
          if (Date.now() - state.t > KC_RESUME_TTL_MS) {
            localStorage.removeItem(KC_RESUME_KEY);
            return null;
          }
          return state;
        } catch (e) { return null; }
      }

      function kcClearState() {
        try { localStorage.removeItem(KC_RESUME_KEY); } catch (e) {}
      }

      // Your images (folder: img/)
      var ITEMS = [
        { id:'kangaroo',   label:'kangaroo',   img:'img/Kangaroo.png' },
        { id:'city',       label:'city',       img:'img/City.png' },
        { id:'toothpaste', label:'toothpaste', img:'img/Toothpaste.png' },
        { id:'forest',     label:'forest',     img:'img/Forest.png' },
        { id:'friends',    label:'friends',    img:'img/Friends.png' },
        { id:'giraffe',    label:'giraffe',    img:'img/Giraffe.png' },
        { id:'karak',      label:'karak',      img:'img/Black Cockatoo.png' },
        { id:'park',       label:'park',       img:'img/Park.png' },
        { id:'beetle',     label:'beetle',     img:'img/Black beetle.png' },
        { id:'bandicoot',  label:'bandicoot',  img:'img/Bandicoot.png' },
        { id:'honeybee',   label:'honeybee',   img:'img/Honeybee.png' },
        { id:'table',      label:'table',      img:'img/Table.png' },
        { id:'zoo_keeper', label:'zoo keeper', img:'img/Zoo Keeper.png' },
        { id:'gum_tree',   label:'gum tree',   img:'img/Gum tree.png' },
        { id:'chameleon',  label:'chameleon',  img:'img/Chameleon.png' },
        { id:'lion',       label:'lion',       img:'img/Lion.png' },
        { id:'pine_tree',  label:'pine tree',  img:'img/Pine_tree.png' },
        { id:'blue_banded_bee', label:'blue banded bee', img:'img/Blue Banded Bee.png' },
        { id:'bobtail',    label:'bobtail',    img:'img/Bobtail.png' },
        { id:'doctor',     label:'doctor',     img:'img/Doctor.png' },
        { id:'peacock',    label:'peacock',    img:'img/Peacock.png' },
      ];

      // scores
      var SCORES = {};
      ITEMS.forEach(function(it){ SCORES[it.id] = 0; });
      ITEMS.forEach(function(it){ try { window[it.id + 'Score'] = 0; } catch(e){} });

      function setItemScore(itemId, score) {
        if (!(itemId in SCORES)) SCORES[itemId] = 0;
        SCORES[itemId] = score;
        try { window[itemId + 'Score'] = score; } catch(e){}
      }

      function cssPxVar(name, fallback) {
        var val = getComputedStyle(document.documentElement).getPropertyValue(name);
        if (!val) return fallback;
        return parseFloat(val);
      }

      // Read responsive CSS vars so JS placement matches what is on screen
      var BOARD_SIZE   = cssPxVar('--size', 820);
      var WHITE_MARGIN = cssPxVar('--white-margin', 240);
      var ORANGE_BAND  = cssPxVar('--orange-band', 120);
      var GREEN_BAND   = cssPxVar('--green-band', 24);

      function computeRadii(boardEl) {
        boardEl = boardEl || document.getElementById('board');
        var red = boardEl.querySelector('.ring.red');
        var orange = boardEl.querySelector('.ring.orange');
        var green = boardEl.querySelector('.ring.green');
        if (red && orange && green) {
          return {
            rRed: red.getBoundingClientRect().width / 2,
            rOrange: orange.getBoundingClientRect().width / 2,
            rGreen: green.getBoundingClientRect().width / 2
          };
        }
        var redDiameter = cssPxVar('--red-diameter', BOARD_SIZE - WHITE_MARGIN);
        var band = cssPxVar('--band', (redDiameter/6));
        var rRed = redDiameter / 2;
        var rOrange = rRed - band;
        var rGreen  = rOrange - band;
        return { rRed: rRed, rOrange: rOrange, rGreen: rGreen };
      }

      // ======= HELPERS =======
      function showError(msg) {
        try {
          var target = document.getElemen
